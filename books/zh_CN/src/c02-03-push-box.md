# 推箱子

在前一节中我们可以控制角色移动了，但是角色可以穿越墙和盒子，对环境中的其它东西根本都不care.做人不能这么横，咋能这么目中无箱子呢？这样还咋推箱子呢？接下来我们就在角色移动的时候添加些逻辑判断让它智能起来.

## 可移动的组件
首先我们需要让代码更通用些．在先前场景我们完成了让玩家控制角色移动的功能，后面我们还需要让箱子也移动起来．说不定以后我们还需要移动其它的什么东西．所以很有必要把组件区分为可移动的和不可移动的．比如:角色箱子是可以移动的;墙是不能移动，角色也不能穿过的;另外还有方框即不像可移动的角色也不像不可移动的墙．

接下来我们增加２个新组件，除了一些小的改变其实也没什么新的:

* 我们使用 `NullStorage` 而不是`VecStorage`，因为这俩个组件没什么属性，只是用做标记，使用`NullStorage`更高效．
* 为了使用`NullStorage`还需要实现`Default`特征．
* 把这俩个组件添加到register_components函数中．


```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:55:62}}

{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:250:259}}
```

接下来:
* 为角色和箱子实现with(Movable) 
* 为墙实现with(Immovable) 
* 地板和方框就不做什么处理了(就像我们先前分析的，方框即不能移动也不能像墙一样阻止角色箱子移动)

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:266:321}}
```

## 移动需求分析
现在我们可以想几种不同的移动场景，这样有助于更好的使用`Moveable`和`Immovable`.

场景:
1. `(player, floor)` ＋ `RIGHT`  -> 角色应右移
1. `(player, wall)`＋ `RIGHT`  -> 角色不能移动
1. `(player, box, floor)` ＋ `RIGHT`  -> 角色和盒子右移
1. `(player, box, wall)` ＋ `RIGHT`  -> 啥都不移动
1. `(player, box, box, floor)` ＋ `RIGHT`  -> 角色, box1 和 box2 都应右移
1. `(player, box, box, wall)` ＋ `RIGHT`  -> 啥都不移动

由此可以得出:
* 碰撞（移动）检测需要所有相关对象一起完成．比如场景6, 如果我们一次检测一个对象，我们就会移动角色，然后移动box1，直到我们检测到box2,才发现box2是不能移动的，因为它前面是个墙，那先前移动的角色和box1还得移动回去.
* 可移动对象碰到空点可以移动的(这里的空点代表即不是可移动对象也不是不可移动对象)．
* 可移动对象碰到不可移动对象不可移动．
* 虽然我们只是根据向右移动的场景分析的，但这些结论同样适用于其它方向．

基于此，就可以编写代码了. 以下是一些我们需要实现的逻辑片段:
1. **找出所有的可移动实体和不可移动实体** - 这样我们才能区分它们是否对应对有影响．
2. **确定基于按键移动实体的方法** - 这个我们先前章节中已经介绍过，可以根据按键在实体位置相应分支上+1或-1;
3. **遍历从角色当前位置到地图末尾的所有位置** 需要根据移动方向判断地图末尾位置，比如按下的向右方向键，那我们就需要遍历玩家当前位置到`地图宽度`的所有位置信息；如果按下的是向上方向键，那就需要从0遍历到`player.y`.
4. **对于序列中的每个图块** 我们需要:
    * 如果当前图块是可移动的，就继续执行并记录下当前的图块.
    * 如果当前图块是不可移动的，就停止执行，什么也不需要移动.
    * 如果当前图块既不是可移动的也不是不可移动的，就移动我们先前记录的所有可移动图块.

下面是新的输入处理的代码,虽然代码有点长但功能实现了！

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:113:197}}
```

现在再运行代码，你会发现角色不再穿越墙了还能推动箱子了．

![Moving player](./images/movement.gif)

下面是完整代码：

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs}}
```

> **_CODELINK:_**  你可以点 [这里](https://github.com/open-mit/rust-sokoban/tree/master/code/rust-sokoban-c02-03)获取目前的完整代码.